<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Manual Add Words</title>
	<link rel="stylesheet" href="lib/bootstrap.min.css">
	<link rel="stylesheet" href="lib/bootstrap-theme.min.css">
	<script src="lib/jquery-2.1.1.min.js"></script>
	<script src="lib/bootstrap.min.js"></script>
	<script src="util.js"></script>
	<style>
		.no-select {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
	</style>
</head>
<body style="background-color: silver;">

<div class="container">


	<div style="padding-top: 50px;"></div>

	<div class="row">
		<div class="col-md-5" style="padding: 0;">
			<div class="text-center" style="background-color: white; height: 750px; border: solid 1px silver;">
				<textarea id="words" style="width: 90%; height: 640px; resize: none; margin: 20px auto 20px auto; border: solid 1px silver;"></textarea>
				<button id="btn-dw" class="btn btn-default btn-lg">Deal With</button>
			</div>
		</div>
		<div class="col-md-7" style="padding: 0;">
			<div style="background-color: white; height: 750px; border: solid 1px silver;">
				<div class="row" style="margin: 20px;">
					<div class="col-md-7" style="border: solid 1px silver;">
						<div style="height: 600px; overflow: auto;">
							<h3>Good words:</h3>
							<div id="tb-good"></div>
						</div>
						<label id="lb-good" style="height: 30px;"></label>
					</div>
					<div class="col-md-5" style="border: solid 1px silver;">
						<div style="height: 600px; overflow: auto;">
							<h3>Bad words:</h3>
							<div id="tb-bad"></div>
						</div>
						<label id="lb-bad" style="height: 30px;"></label>
					</div>
				</div>
				<span style="padding-left: 190px;"></span>
				<button id="btn-add" class="btn btn-default btn-lg">Add Words</button>
				<span style="padding-left: 50px;"></span>
				<button id="btn-home" class="btn btn-default btn-lg">Return Home</button>
			</div>
		</div>
	</div>
	
</div>

<script>
	var good = [];
	var bad = [];
	
	function SelectIndex(e, ind) {
		if (e.target.tagName != "INPUT") {
			var cb = $("input[type=checkbox]");
			for (var i = 0; i < cb.length; i++) {
				if (ind == parseInt(cb[i].name)) {
					$(cb[i]).prop("checked", !$(cb[i]).prop("checked"));
					break;
				}
			}
		}
		$("#lb-good").html("" + (good.length) + " words, " + $("input:checked").length + " choiced");
		return false;
	}
	
	$(document).on("ready", function () {
		$("#btn-dw").on("click", function () {
			var words = $("#words").val();
			
			// crazy deal with content, wow
			
			var re = new RegExp("[^0-9a-zA-Z\-\ ]+", "g");
			words = words.replace(re, " ");
			if (words.indexOf("  ") != -1)
				words = words.replace(/\ \ /g, " ");
			words = words.split(" ");
			
			//
			var nl = [];
			for (var i in words) {
				var w = words[i].trim().toLowerCase();
				if (w != "" && nl.indexOf(w) == -1) {
					nl.push(w);
				}
			}
			words = nl;
			if (words.length <= 0) return;
		
			TestWord(words, function (result) {
				if (result) {
					good = [];
					bad = [];
					// 这么做是因为从服务器传回来的结果是可能有重复的
					for (var i in result.good) {
						if (good.indexOf(result.good[i]) == -1)
							good.push(result.good[i]);
					}
					for (var i in result.bad) {
						if (bad.indexOf(result.bad[i]) == -1)
							bad.push(result.bad[i]);
					}
					
					function length_letter_sort(a, b) {
						if (a.length != b.length) {
							return b.length - a.length;
						} else {
							return a > b;
						}
					}
					
					good.sort(length_letter_sort);
					bad.sort(length_letter_sort);
					
					var html = ""
					for (var i in good) {
						html += "<div onclick='return SelectIndex(event," + i + ");' class='input-group'><span class='input-group-addon' >";
						html += "<input type='checkbox' name='" + i + "'>";
						html += "</span>";
						html += "<label class='form-control no-select' style='width: 95%;'>" + good[i] + "</label>";
						html += "</div>"
					}
					$("#tb-good").html(html);
					html = "";
					for (var i in bad) {
						html += "<div class='input-group'><span class='input-group-addon' >-";
						html += "</span>";
						html += "<label class='form-control no-select' style='width: 95%;'>" + bad[i] + "</label>";
						html += "</div>"
					}
					$("#tb-bad").html(html);
					$("#lb-bad").html("" + (bad.length) + " words");
            
					var cb = $("input[type=checkbox]");
					for (var i = 0; i < cb.length; i++) {
						var t = cb[i];
						var ind = t.name;
						ind = parseInt(ind);
            var w = good[ind];
						if (w.length >= Config.get("WordSelectLength") && IgnoreExist(w) == false && ListExist(w) == false) {
							$(t).prop("checked", true);
						}
					}
					
					
					$("#lb-good").html("" + (good.length) + " words, " + $("input:checked").length + " choiced");
					
				} else {
					console.log(result);
					alert("Something wrong");
				}
			});
		});

		$("#btn-add").on("click", function () {
			var cb = $("input:checked");
			if (cb.length <= 0) {
				Alert("You choice nothing");
				return;
			}
			
			Confirm("Do you want add the choiced good word into list?", function (yes) {
				if (yes) {
					var words = [];
					for (var i = 0; i < cb.length; i++)
						words.push(good[parseInt(cb[i].name)]);
					var wl = DB.load("list");
					var now = ""+ (new Date()).getTime();
					var nwl = [];
					for (var i in words) {
						var e = {};
						e.word = words[i];
						e.date = now;
						e.next = now;
						e.count = -1;
						e.fail = 0;
						nwl.push(e);
					}
					DB.save("list", nwl.concat(wl));
          
          var ign = DB.load("ignore");
          for (var i in good) {
            var w = good[i];
            if (IgnoreExist(w) == false)
              ign.push(w);
          }
          DB.save("ignore", ign);
          
					Confirm("Words added successfully. Do you want back home?", function (yes) {
						if(yes)
							window.location.href = "/";
					});
				}
			});
		});
		
		$("#btn-home").on("click", function () {
			window.location.href = "/";
		});
	});
</script>
</body>
</html>