<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Setting</title>
	<link rel="stylesheet" href="lib/bootstrap.min.css">
	<link rel="stylesheet" href="lib/bootstrap-theme.min.css">
	<script src="lib/jquery-2.1.1.min.js"></script>
	<script src="lib/bootstrap.min.js"></script>
	<script src="lib/FileSaver.js"></script>
	<script src="util.js"></script>
	<style>
	</style>
</head>
<body style="background-color: silver;">

<div class="container">

	<div style="padding-top: 50px;"></div>

	<div class="row">
		<div class="col-md-5" style="padding: 0;">
			<div class="text-center" style="background-color: white; height: 750px; border: solid 1px silver;">
				<div class="container" style="height: 640px; width: 95%; margin: 15px; overflow: auto;">	
					<div style="padding-top: 20px;"></div>
					<div class="input-group">
					  <span class="input-group-addon" style="width: 200px;">Max study count</span>
					  <input type="number" id="cfg-studycount" min="5" max="500" step="5" class="form-control" style="text-align: center;">
					</div>
					<br>
					<div class="input-group">
					  <span class="input-group-addon" style="width: 200px;">Max review count</span>
					  <input type="number" id="cfg-reviewcount" min="5" max="500" step="5" class="form-control" style="text-align: center;">
					</div>
					<br>
					<div class="input-group">
					  <span class="input-group-addon" style="width: 200px;">Word select length</span>
					  <input type="number" id="cfg-wordselectlength" min="5" max="500" step="5" class="form-control" style="text-align: center;">
					</div>
				</div>
				<div style=" margin: 15px;">
					<button id="btn-ss" class="btn btn-default btn-lg">Save Setting</button>
					<button id="btn-def" class="btn btn-default btn-lg">Default</button>
					<button id="btn-home" class="btn btn-default btn-lg">Home</button>
				</div>
			</div>
		</div>
		<div class="col-md-7" style="padding: 0;">
			<div style="background-color: white; height: 750px; border: solid 1px silver;">
        <div style="padding-top: 200px;"></div>
				<span style="padding-left: 150px;"></span>
        <label id="lb-info"></label>
				<div style=" margin: 15px;">
					<span style="padding-left: 100px;">
					<button id="btn-export" class="btn btn-default btn-lg">Export</button>
					<button id="btn-import" class="btn btn-default btn-lg">Import</button>
					<button id="btn-reset" class="btn btn-default btn-lg">Reset</button>
				</div>
			</div>
		</div>
	</div>
	<input id="file" type="file" style="width: 0; height: 0;">

</div>

<script>
	function LoadSetting () {
		$("#cfg-studycount").val(Config.get("StudyCount"));
		$("#cfg-reviewcount").val(Config.get("ReviewCount"));
		$("#cfg-wordselectlength").val(Config.get("WordSelectLength"));
	}
	
	function SaveSetting () {
		var v;
		var n;
		//1
		v = $("#cfg-studycount").val();
		n = parseInt(v);
		if (v.match(/^[0-9]+$/) == null || isNaN(n)) {
			Alert("Invalid study count value");
			return;
		}
		Config.set("StudyCount", n);
		
		//2
		v = $("#cfg-reviewcount").val();
		n = parseInt(v);
		if (v.match(/^[0-9]+$/) == null || isNaN(n)) {
			Alert("Invalid review count value");
			return;
		}
		Config.set("ReviewCount", n);
		
		//3
		v = $("#cfg-wordselectlength").val();
		n = parseInt(v);
		if (v.match(/^[0-9]+$/) == null || isNaN(n)) {
			Alert("Invalid word select length value");
			return;
		}
		Config.set("WordSelectLength", n);
		
		
		// load it again, if the save didn't right, user will know it
		LoadSetting();
	}
	
	function ShowInfo () {
		var len = bytelength(JSON.stringify(window.localStorage));
		$("#lb-info").html("" + (len/1024).toFixed(2) + " KBytes used");
	}

	$(document).on("ready", function () {
		ShowInfo();
	
		$("#btn-home").on("click", function () {
			window.location.href = "/";
		});
	
		$("#btn-export").on("click", function () {
			var s = {};
      for (var i in window.localStorage) {
        if (i != "dict")
          s[i] = window.localStorage[i];
      }
			s = JSON.stringify(s);
			s = b64en(s);
      
      var now = new Date();
      var filename = "WordStudy_save_" + now.getFullYear() + "_" + (now.getMonth() + 1) + "_" + now.getDate() + ".txt";
      
      var blob = new Blob([s], {type: "text/plain;charset=utf-8"});
      saveAs(blob, filename);
		});
		
		$("#btn-import").on("click", function () {
      $("#file").click();
		});
    
  $("#file").on("change", function () {
		var f = $("#file")[0];
		if (f.files && f.files.length > 0) {
			var file = f.files[0];
			console.log(file);
			var name = file.name;
			var ext = name.substr(name.length - 3);
			name = name.substr(0, name.length - 4);
			
			if (ext != "txt") {
				Alert("Only text file support");
				return;
			}
			
			var reader = new FileReader();
			reader.onerror = function () {
				Alert("Load file faiure");
			};
			reader.onload = function (e) {
				var v = this.result;
        v = v.trim();
        if (v == "") return;
        v = b64de(v);
        var j;
        try {
          j = JSON.parse(v);
        } catch (e) {
          console.log(e);
          Alert("Save data parse error");
          return;
        }
        
        Confirm("Are you sure load the save data?", function (yes) {
          if (yes) {
            for (var i in j) {
              window.localStorage[i] = j[i];
            }
            ShowInfo();
          }
        });
			};
			reader.readAsText(file);
		}
	});
		
		$("#btn-reset").on("click", function () {
			Confirm("Are you sure reset all data?", function (yes) {
				if (yes) {
					DB.reset();
          ShowInfo();
				}
			});
		});
		
		$("#btn-ss").on("click", function () {
			SaveSetting();
		});
		
		$("#btn-def").on("click", function () {
			Confirm("Are you sure restore all setting to default?", function (yes) {
				if (yes) {
					Config.reset();
					LoadSetting();
				}
			});
		});
		
		LoadSetting();
	});
	
</script>
</body>
</html>