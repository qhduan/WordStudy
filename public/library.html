<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Words Library</title>
	<link rel="stylesheet" href="lib/bootstrap.min.css">
	<link rel="stylesheet" href="lib/bootstrap-theme.min.css">
	<script src="lib/jquery-2.1.1.min.js"></script>
	<script src="lib/bootstrap.min.js"></script>
	<script src="util.js"></script>
</head>
<body style="background-color: silver;">

<div class="container">

	<div style="padding-top: 50px;"></div>
	<div class="row">
		<div class="col-md-12" style="padding: 0;">
			<div class="text-center" style="background-color: white; height: 750px; border: solid 1px silver;">
				<div style="height: 640px; margin: 20px auto 20px auto; ">
					<table id="lib" class="table table-striped" style=""></table>
				</div>
				<label id="info"></label>
				<button id="btn-prev" class="btn btn-default btn-lg">Prev Page</button>
				<button id="btn-next" class="btn btn-default btn-lg">Next Page</button>
				<span style="padding-left: 50px;"></span>
				<button id="btn-import" class="btn btn-default btn-lg">Import</button>
				<span style="padding-left: 50px;"></span>
				<button id="gohome" class="btn btn-default btn-lg">Return Home</button>
			</div>
		</div>
	<div>
	<input id="file" type="file" style="width: 0; height: 0;">
	
</div>

<script>
	var ItemOfPage = 16;
	var CurrentPage = 0;
	var MaxPage = -1;

	function ShowTable () {
		var lib = DB.load("lib");
		var c = "<thead><tr><td>Choosen</td><td>Name</td><td>Learned</td><td>Count</td><td>Reset</td><td>Delete</td></tr></thead><tbody>";
		var count = 0;
		for (var i = CurrentPage * ItemOfPage; i < lib.length; i++) {
			var e = lib[i];
			var h = "<tr>";
			h += "<td>" + "<input type='radio' name='" + e.name + "'>" + "</td>";
			h += "<td>" + e.name + "</td>";
			h += "<td>" + e.learned + "</td>";
			h += "<td>" + e.total + "</td>";
			h += "<td>" + "<button class='btn btn-default btn-sm' name='" + i + "'>Reset</button>" + "</td>";
			h += "<td>" + "<button class='btn btn-default btn-sm' name='" + i + "'>Delete</button>" + "</td>";
			h += "</tr>"
			c += h;
			count++;
			if (count >= ItemOfPage)
				break;
		}
		c += "</tbody>";
		$("#lib").html(c);
		
		var cl = Config.get("ChoosenLibrary");
		if (cl != "") {
			$("input[type='radio']").each(function () {
				if (this.name == cl) {
					$(this).prop("checked", true);
				}
			});
		}
		
		if (lib.length > ItemOfPage) {
			MaxPage = Math.ceil(lib.length / WordsOfPage) - 1;
			if (CurrentPage >= MaxPage) {
				$("#btn-next").prop("disabled", true);
			} else {
				$("#btn-next").prop("disabled", false);
			}
			if (CurrentPage == 0) {
				$("#btn-prev").prop("disabled", true);
			} else {
				$("#btn-prev").prop("disabled", false);
			}
			
			$("#info").html("" + (CurrentPage + 1) + " of " + (MaxPage + 1) + " pages, " + lib.length + " libraries");
		} else {
			$("#btn-prev").prop("disabled", true);
			$("#btn-next").prop("disabled", true);
			$("#info").html("1 of 1 page, " + lib.length + " libraries");
		}
	}
	
	$(document).on("ready", function () {
		ShowTable();
	});
	
	$("#gohome").on("click", function () {
		window.location.href = "/";
	});
	
	$("#btn-import").on("click", function () {
		$("#file").click();
	});
	
	$("#file").on("change", function () {
		var f = $("#file")[0];
		if (f.files && f.files.length > 0) {
			var file = f.files[0];
			console.log(file);
			var name = file.name;
			var ext = name.substr(name.length - 3);
			name = name.substr(0, name.length - 4);
			
			if (ext != "txt") {
				Alert("Only text file support");
				return;
			}
			
			var lib = DB.load("lib");
			for (var i in lib) {
				if (lib[i].name == name) {
					Alert("Name of library already exists");
					return;
				}
			}
			
			var reader = new FileReader();
			reader.onerror = function () {
				Alert("Load file faiure");
			};
			reader.onload = function (e) {
				var r = this.result;
				r = r.replace(/\r/g, "");
				r = r.split("\n");
				var w = [];
				for (var i in r) {
					var t = r[i];
					t = t.trim();
					if (t != "" && t.match(/^[a-zA-Z0-9\ \-]+$/))
						w.push(t);
				}
				if (w.length <= 0) {
					Alert("No valid word in file");
					return;
				}
				
				TestWord(w, function (result) {
					if (result) {
						var valid = [];
						var invalid = [];
						for (var i = 0; i < w.length; i++) {
							if (result[i] == 1)
								valid.push(w[i]);
							else
								invalid.push(w[i])
						}
						
						if (valid.length == 0) {
							Alert("We don't have all words' defination, nothing could be done");
						} else if (invalid.length == 0) {
							var lib = DB.load("lib");
							var elem = {};
							elem.name = name;
							elem.words = valid;
							elem.learned = 0;
							elem.total = valid.length;
							lib.push(elem);
							DB.save("lib", lib);
							ShowTable();
						} else {
							Confirm("Some words can't be add to library, do you want add the valid ones?<br>" + JSON.stringify(invalid), function (yes) {
								if (yes) {
									var lib = DB.load("lib");
									var elem = {};
									elem.name = name;
									elem.words = valid;
									elem.learned = 0;
									elem.total = valid.length;
									lib.push(elem);
									DB.save("lib", lib);
									ShowTable();
								}
							});
						}
					} else {
						Alert("Something wrong");
					}
				});
			};
			reader.readAsText(file);
		}
	});
	
	$("#btn-prev").on("click", function () {
		if (CurrentPage > 0) {
			CurrentPage--;
			ShowTable();
		}
	});
	
	$("#btn-next").on("click", function () {
		if (CurrentPage < MaxPage) {
			CurrentPage++;
			ShowTable();
		}
	});
	
	$("#lib").on("click", function (e) {
		var btn = e.target;
		//console.log(btn);
		var ind = btn.name;
		var lib = DB.load("lib");
		var name = lib[ind].name;
		if (btn.innerHTML == "Delete") { // delete button
			Confirm("Are you sure deleting '" + name + "'?", function (yes) {
				if (yes) {
					lib = lib.slice(0, ind).concat(lib.slice(ind + 1, lib.length))
					DB.save("lib", lib);
					if (Config.get("ChoosenLibrary") == name) {
						Config.set("ChoosenLibrary", "");
					}
					ShowTable();
				}
			});
		} else if (btn.innerHTML == "Reset") { // reset button
			Confirm("Are you sure reset '" + name + "'?", function (yes) {
				if (yes) {
					lib[ind].learned = 0;
					DB.save("lib", lib);
					ShowTable();
				}
			});
		}
	});
	
	$("#lib").on("change", function (e) {
		var rb = e.target;
		var name = rb.name;
		Confirm("Are you sure make '" + name + "' be the choosen library?", function (yes){
			if (yes) {
				Config.set("ChoosenLibrary", name);
				ShowTable();
			} else {
				$(rb).prop("checked", false);
			}
		});
	});
</script>
</body>
</html>