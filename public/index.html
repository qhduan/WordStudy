<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>QHD's Word Review Tool</title>
	<link rel="stylesheet" href="lib/bootstrap.min.css">
	<link rel="stylesheet" href="lib/bootstrap-theme.min.css">
	<script src="lib/jquery-2.1.1.min.js"></script>
	<script src="lib/bootstrap.min.js"></script>
	<script src="util.js"></script>
	<style>
	.btn-me {
		height: 100px;
		width: 100px;
		margin: 10px;
	}
	</style>
</head>
<body style="background-color: silver;">

<div class="container">

	<div style="padding-top: 50px;"></div>

	<div class="row">
		<div class="col-md-5" style="padding: 0;">
			<div class="text-center" style="background-color: white; height: 750px; border: solid 1px silver;">
				<div>
					<div style="padding-top: 150px;"></div>
					<h1>Look up a word:</h1>
					<br>
					<input id="word" type="text" style="width: 50%; height: 40px; width: 350px; text-align: center; font-size: 2em;">
				</div>
        <div style="text-align: center; padding-top: 50px;">
          <label id="lb-nexttime">Next review: </label>
        </div>
				<div>
					<div style="padding-top: 100px;"></div>
					<button id="btn-study" class="btn btn-default btn-lg btn-me">Study</button>
					<button id="btn-review" class="btn btn-default btn-lg btn-me">Review</button>
					<button id="btn-list" class="btn btn-default btn-lg btn-me">List</button>
					<br>
					<button id="btn-library" class="btn btn-default btn-lg btn-me">Library</button>
					<button id="btn-manual" class="btn btn-default btn-lg btn-me">Manual</button>
					<button id="btn-setting" class="btn btn-default btn-lg btn-me">Setting</button>
				</div>
			</div>
		</div>
		<div class="col-md-7" style="padding: 0;">
			<div style="background-color: white; height: 750px; border: solid 1px silver;">
				<div id="def" style="disploy: block; height: 720px; overflow: auto; margin: 15px; "></div>
			</div>
		</div>
	</div>




</div>

<script>

  var nexttime = null;

	//测试现在是否需要复习
	function TestReview () {
		var wl = DB.load("list");
		if (wl.length <= 0) {
			return false;
		}
    
    wl.sort(function (a, b) {
      if (a.next < b.next)
        return -1;
      else if (a.next > b.next)
        return 1;
      else
        return 0;
    });
    
    nexttime = wl[0].next;
    
		var now = (new Date()).getTime();
		for (var i = 0; i < wl.length; i++) {
			if (wl[i].next < now && wl[i].count >= 0) {
				return true;
			}
		}
		return false;
	}
	
	//测试现在单词表中是否有单词可以初记
	function TestStudy () {
		var wl = DB.load("list");
		if (wl.length <= 0) {
			return false;
		}
		for (var i = 0; i < wl.length; i++) {
			if (wl[i].count == -1) {
				return true;
			}
		}
		return false;
	}
	
	//测试单词库中是否有可以导入单词的选中数据库
	function TestStudyLibrary () {
		var lib = DB.load("lib");
		var name = Config.get("ChoosenLibrary");
		if (name == "") {
			return false;
		} else {
			for (var i in lib) {
				if (lib[i].name == name && lib[i].learned < lib[i].total) {
					return true;
				}
			}
			return false;
		}
	}
	
	//查询并显示单词词义
	function ShowWord(word) {
		//远程下载单词词义
		GetWord([word], function () {
			if (define(word)) {
				$("#def").html(define(word));
			} else {
				$("#def").html("<b>Not found</b>");
			}
			$("#word").select()
		});
	}
	
	//返回选中单词库的索引，如果没有则返回-1
	function GetChoosenLibraryIndex () {
		var name = Config.get("ChoosenLibrary");
		if (name == "") {
			return -1;
		}
		var lib = DB.load("lib");
		for (var i in lib) {
			if (lib[i].name == name && lib[i].learned < lib[i].total) {
				return i;
			}
		}
		return -1;
	}
	
	$(document).on("ready", function () {
		if (TestReview())
			$("#btn-review").prop("disabled", false);
		else
			$("#btn-review").prop("disabled", true);
      
    if (nexttime != null) {
      $("#lb-nexttime").html("Next review: " + DateToString(nexttime));
    }
			
		if (TestStudy() || TestStudyLibrary())
			$("#btn-study").prop("disabled", false);
		else
			$("#btn-study").prop("disabled", true);
		
		$("#word").focus();
		
		$("#def").on("click", function (e) {
			var t = e.target;
			if (t.href == undefined) return;
			var url = t.href;
			var word = url.substr(8);
			ShowWord(word);
			return false;
		});
		
		//单词输入栏改变之后
		$("#word").on("change", function () {
			ShowWord($("#word").val());
		});
		
		//进入单词表
		$("#btn-list").on("click", function () {
			window.location.href = "list.html";
		});
		
		//进入手工单词添加
		$("#btn-manual").on("click", function () {
			window.location.href = "manual.html";
		});
		
		//进入单词复习
		$("#btn-review").on("click", function () {
			window.location.href = "review.html";
		});
		
		//进入程序设置
		$("#btn-setting").on("click", function () {
			window.location.href = "setting.html";
		});
		
		//进入单词库
		$("#btn-library").on("click", function () {
			window.location.href = "library.html";
		});
		
		//单词初记
		$("#btn-study").on("click", function () {
			//如果单词表中没初记单词，但是单词库中的单词可以导入
			if (TestStudy() == false && TestStudyLibrary()) {
				Confirm("No new words in list, do you want load some words from choosen library and learn?", function (yes) {
					if (yes) {
						var lib = DB.load("lib");
						var name = Config.get("ChoosenLibrary");
						var ind = GetChoosenLibraryIndex();
						var clib = lib[ind];
						var list = [];
						for (var i = clib.learned; i < clib.total; i++) {
							if (list.length >= 5) break;
							list.push(clib.words[i]);
						}
						
						lib[ind].learned += list.length;
						DB.save("lib", lib);
						
						var now = (new Date()).getTime();
						var nwl = [];
						for (var i in list) {
							var e = {};
							e.word = list[i];
							e.date = now;
							e.next = now;
							e.count = -1;
							e.fail = 0;
							nwl.push(e);
						}
						var wl = DB.load("list");
						DB.save("list", nwl.concat(wl));
						window.location.href = "study.html";
					}
				});
			} else {
				window.location.href = "study.html";
			}
		});
	});
</script>
</body>
</html>