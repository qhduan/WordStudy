<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Study Words</title>
	<link rel="stylesheet" href="lib/bootstrap.min.css">
	<link rel="stylesheet" href="lib/bootstrap-theme.min.css">
	<script src="lib/jquery-2.1.1.min.js"></script>
	<script src="lib/bootstrap.min.js"></script>
	<script src="util.js"></script>
</head>
<body style="background-color: silver;">

<div class="container">

	<div style="padding-top: 50px;"></div>

	<div class="row">
		<div class="col-md-5" style="padding: 0;">
			<div class="text-center" style="background-color: white; height: 750px; border: solid 1px silver;">
				<div style="padding-top: 100px;"></div>
				<div style="height: 75%;">
					<label id="word" style="font-size: 3em;">word</label>
					<div style="padding-top: 150px;"></div>
					<input id="wordinput" type="text" style="width: 50%; height: 40px; width: 350px; text-align: center; font-size: 2em;">
					<div style="padding-top: 50px;"></div>
					<button id="btn-pass" class="btn btn-default btn-lg">Pass (Tab)</button>
					<div style="padding-top: 150px;"></div>
					<label id="info" style="font-size: 1em;">info</label>
				</div>
				<div style="height: 10%;">
					<button id="btn-home" class="btn btn-default btn-lg">Return Home</button>
				</div>
			</div>
		</div>
		<div class="col-md-7" style="padding: 0;">
			<div style="background-color: white; height: 750px; border: solid 1px silver;">
				<div id="def" style="disploy: block; height: 720px; overflow: auto; margin: 15px; "></div>
			</div>
		</div>
	</div>

</div>

<script>

	
	function TestStudyLibrary () {
		var lib = DB.load("lib");
		var name = Config.get("ChoosenLibrary");
		if (name == "") {
			return false;
		} else {
			for (var i in lib) {
				if (lib[i].name == name && lib[i].learned < lib[i].total) {
					return true;
				}
			}
			return false;
		}
	}

	var rwl = [];
	var CurrentIndex = 0;
	var ignore = [];
	
	$(document).on("ready", function () {
		var wl = DB.load("list");
		if (wl.length <= 0) {
			Alert("No words", function () {
				window.location.href = "/";
			});
		}
		var list = [];
		for (var i = 0; i < wl.length; i++) {
			if (wl[i].count == -1) {
				list.push(wl[i].word);
				
				var e = {}
				e.word = wl[i].word;
				e.ind = i;
				rwl.push(e);
				if (rwl.length >= Config.get("StudyCount"))
					break;
			}
		}
		
		if (rwl.length <= 0) {
			Alert("No words could study", function () {
				window.location.href = "/";
			});
		} else {	
			GetWord(list, function () {
				for (var i = 0; i < rwl.length; i++) {
					rwl[i].def = define(rwl[i].word);
				}
				
				ShowWord();
				$("#wordinput").focus();
			});
		}
		
		$(document).on("keypress", function (e) {
			var k = e.keyCode;
			if (k == 9) {
				$("#btn-pass").click();
				return false;
			}
			return true;
		});
		
		$("#def").on("click", function (e) {
			var t = e.target;
			if (t.href == undefined) return;
			var url = t.href;
			var word = url.substr(8);
			DynamicShowWord(word);
			return false;
		});
	});
	
	function DynamicShowWord(word) {
		//动态加载某个单词
		GetWord([word], function () {
			if (define(word)) {
				$("#def").html(define(word));
			}
			$("#word").select()
		});
	}
	
	function ShowWord () {
		var elem = rwl[CurrentIndex];
		$("#word").html(elem.word);
		$("#def").html(elem.def);
		
		$("#info").html("" + (CurrentIndex + 1) + " of " + rwl.length);
	}
	
	$("#btn-home").on("click", function () {
		if (CurrentIndex != 0) {
			Confirm("Are you sure stopping study and return home?", function (yes) {
				if (yes) window.location.href = "/";
			});
		} else {
			window.location.href = "/";
		}
	});
	
	function StudyOver () {
		Confirm("Study over?", function (yes) {
			if (yes) {
				var wl = DB.load("list");
				for (var i in rwl) {
					var ind = rwl[i].ind;
					wl[ind].count = 0;
				}
				if (ignore.length > 0) {
					var nwl = [];
					for (var i = 0; i < wl.length; i++) {
						if (ignore.indexOf(i) == -1)
							nwl.push(wl[i]);
					}
					wl = nwl;
				}
				DB.save("list", wl);
				window.location.href = "review.html";
			}
		});
	}
	
	$("#btn-pass").on("click", function () {
		var elem = rwl[CurrentIndex];
		ignore.push(elem.ind);
		if (CurrentIndex == (rwl.length - 1)) {
			StudyOver();
		} else {
			CurrentIndex++;
			ShowWord();
			$("#wordinput").val("");
			$("#wordinput").focus();
		}
		$("#btn-pass").prop("disabled", true);
		setTimeout(function () {
			$("#btn-pass").prop("disabled", false);
		}, 250);
		$("#btn-pass").trigger("blur");
	});
	
	$("#wordinput").on("keypress", function (e) {
		if (e.keyCode == 27) { // press esc
			setTimeout(function () {
				$("#wordinput").val("");
				$("#wordinput").focus();
			}, 10);
		} else if (e.which == 13) { // press enter
			var w = $("#wordinput").val();
			w = w.trim();
			if (w == rwl[CurrentIndex].word) {
				if (CurrentIndex == (rwl.length - 1)) {	// last one
					StudyOver();
				} else {
					CurrentIndex++;
					ShowWord();
					$("#wordinput").val("");
				}
			} else {
				$("#word").css("color", "red");
				var t = 50;
				$("#word").animate({"margin-left": "50px"}, t).animate({"margin-left": "0px"}, t)
					.animate({"margin-left": "50px"}, t).animate({"margin-left": "0px"}, t)
					.animate({"margin-left": "50px"}, t).animate({"margin-left": "0px"}, t)
				setTimeout(function () {
					$("#word").css("color", "black");
					$("#wordinput").select();
					$("#wordinput").focus();
				}, t*6);
			}
		}
		return true;
	});
</script>
</body>
</html>