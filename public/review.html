<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Review Words</title>
	<link rel="stylesheet" href="lib/bootstrap.min.css">
	<link rel="stylesheet" href="lib/bootstrap-theme.min.css">
	<script src="lib/jquery-2.1.1.min.js"></script>
	<script src="lib/bootstrap.min.js"></script>
	<script src="util.js"></script>
	<style>
		.btn-me {
			height: 120px;
			width: 180px;
			margin: 20px;
		}
    
		.no-select {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
    
	</style>
</head>
<body style="background-color: silver;">

<div class="container">

	<div style="padding-top: 50px;"></div>

	<div class="row">
		<div class="col-md-5" style="padding: 0;">
			<div class="text-center" style="background-color: white; height: 750px; border: solid 1px silver;">
				<div style="padding-top: 100px;"></div>
				<div>
					<label id="word" style="font-size: 3em;"></label>
				</div>
				<div>
					<div style="padding-top: 100px;"></div>
					<h4 id="word-info"></h4>
				</div>
				<div>
					<div style="padding-top: 75px;"></div>
					<button id="btn-not" class="btn btn-default btn-lg btn-me"><u>N</u>ot Exactly</button>
					<button id="btn-remember" class="btn btn-default btn-lg btn-me"><u>R</u>emember</button>
          
					<button id="btn-wrong" class="btn btn-default btn-lg btn-me" style="display: none;">Wro<u>n</u>g</button>
					<button id="btn-right" class="btn btn-default btn-lg btn-me" style="display: none;"><u>R</u>ight</button>
				</div>
				<div>
					<div style="padding-top: 50px;"></div>
					<label id="info" style="font-size: 1em;"></label>
					<br>
					<button id="btn-home" class="btn btn-default btn-lg">Return Home</button>
				</div>
			</div>
		</div>
		<div class="col-md-7" style="padding: 0;">
			<div style="background-color: white; height: 750px; border: solid 1px silver;">
				<div id="def" style="disploy: block; height: 720px; overflow: auto; margin: 15px; "></div>
			</div>
		</div>
	</div>

</div>

<script>

	//保存本次学习的单词列表
	var rwl = [];
  
  //保存已经学完的单词
  var good = [];
  
	//保存正在学习的单词在rwl中的序号
	var CurrentIndex = 0;
  
  var testList = ["banana", "apple", "school", "house", "friend"];
	
	function ShowWord () {
		$("#word").html(rwl[CurrentIndex].word);
		$("#def").html("");
		$("#info").html("" + rwl.length);
	}
  
  function ShowNext () {
    var newIndex = Math.floor(Math.random() * rwl.length);
    while (rwl.length > 1 && newIndex == CurrentIndex) {
      newIndex = Math.floor(Math.random() * rwl.length);
    }
    CurrentIndex = newIndex;
    ShowWord();
  }
	
  function Init (callback) {
		var wl = DB.load("list");
		if (wl.length <= 0) {
			Alert("No words", function () {
				window.location.href = "/";
			});
      return;
		}
		var list = [];
		var now = (new Date()).getTime();
		for (var i = 0; i < wl.length; i++) {
			if (wl[i].next < now && wl[i].count >= 0) {
				list.push(wl[i].word);
				var e = {}
				e.word = wl[i].word;
				e.ind = i;
				e.remember = true;
				rwl.push(e);
				if (rwl.length >= Config.get("ReviewCount"))
					break;
			}
		}
		
		if (rwl.length <= 0) {
			Alert("No words could review", function () {
				window.location.href = "/";
			});
		} else {
      testList.forEach(function (it) {
        list.push(it);
      });
    
			GetWord(list, function () {
				for (var i = 0; i < rwl.length; i++) {
					rwl[i].def = define(rwl[i].word);
				}
        
        callback && callback();
			});
		}
  }
  
  // 结束背诵
  function Finish () {    
    Alert("Review finish", function () {
      var wl = DB.load("list");
      var now = (new Date()).getTime();
      var SECOND = 1000;
      var MINUTE = 60 * SECOND;
      var HOUR = 60 * MINUTE;
      var DAY = 24 * HOUR;
      var WEEK = 7 * DAY;
      var MONTH = 4 * WEEK;
      
      var TIMECAL = [HOUR, DAY, 3 * DAY, WEEK, 2 * WEEK, MONTH, 2 * MONTH, 5 * MONTH, 12 * MONTH, 24 * MONTH, 36 * MONTH, 48 * MONTH];
      for (var i in good) {
        var ind = good[i].ind;
        wl[ind].next = now + TIMECAL[wl[ind].count];
        wl[ind].count++;
      }
      DB.save("list", wl);
      window.location.href = "/";
    });
  }

  $("#btn-remember").on("click", function () {
    $("#def").html(rwl[CurrentIndex].def);
    
    $("#btn-wrong").show();
    $("#btn-right").show();
    $("#btn-wrong").prop("disabled", false);
    $("#btn-right").prop("disabled", false);
    
    $("#btn-remember").hide();
    $("#btn-not").hide();
  });

  $("#btn-not").on("click", function () {
    $("#def").html(rwl[CurrentIndex].def);
    
    $("#btn-wrong").show();
    $("#btn-right").show();
    $("#btn-wrong").prop("disabled", false);
    $("#btn-right").prop("disabled", true);
    
    $("#btn-remember").hide();
    $("#btn-not").hide();
  });

  $("#btn-right").on("click", function () {
    if (rwl[CurrentIndex].first) {
      good.push(rwl[CurrentIndex]);
      rwl.splice(CurrentIndex, 1);
    } else {
      rwl[CurrentIndex].first = true;
    }
    
    if (rwl.length == 0) {
      return Finish();
    }
    
    ShowNext();
    
    $("#btn-wrong").hide();
    $("#btn-right").hide();
    
    $("#btn-remember").show();
    $("#btn-not").show();
  });

  $("#btn-wrong").on("click", function () {
    ShowNext();
    
    $("#btn-wrong").hide();
    $("#btn-right").hide();
    
    $("#btn-remember").show();
    $("#btn-not").show();
  });

  
  //返回主页
  $("#btn-home").on("click", function () {
    if (CurrentIndex != 0) {
      Confirm("Are you sure stopping review?", function (yes) {
        if (yes) {
          window.location.href = "/";
        }
      });
    } else {
      window.location.href = "/";
    }
  });
  
  $(document).on("keypress", function (e) {
    var k = e.which;
    if (k == 82 || k == 114) { // R | r
      if ($("#btn-remember").css("display") == "none") {
        if (!$("#btn-right").prop("disabled")) $("#btn-right").click();
      } else {
        if (!$("#btn-remember").prop("disabled")) $("#btn-remember").click();
      }
    } else if (k == 78 || k == 110) { // N | n
      if ($("#btn-not").css("display") == "none") {
        if (!$("#btn-wrong").prop("disabled")) $("#btn-wrong").click();
      } else {
        if (!$("#btn-not").prop("disabled")) $("#btn-not").click();
      }
    }
  });
  
  $("#def").on("click", function (e) {
    var t = e.target;
    if (t.href == undefined) return;
    var url = t.href;
    var word = url.substr(8);
    DynamicShowWord(word);
    return false;
  });
	
	function DynamicShowWord(word) {
		//动态加载某个单词
		GetWord([word], function () {
			if (define(word)) {
				$("#def").html(define(word));
			}
			$("#word").select()
		});
	}
  
  
	$(document).on("ready", function () {
    Init(function () {
      ShowNext();
    });
  });
</script>
</body>
</html>
